# Flowsurface ç»„ä»¶å…³ç³»å¯è§†åŒ–

## ğŸ“Š ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Flowsurface ä¸»åº”ç”¨                              â”‚
â”‚                           (src/main.rs - Elmæ¶æ„)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Sidebar       â”‚    â”‚  Dashboard      â”‚    â”‚  Modal Windows    â”‚      â”‚
â”‚  â”‚  â”œâ”€ Tickers    â”‚â—„â”€â”€â”€â”¤  â”œâ”€ PaneGrid   â”‚    â”‚  â”œâ”€ Settings      â”‚      â”‚
â”‚  â”‚  â”œâ”€ Search     â”‚    â”‚  â”œâ”€ Streams    â”‚    â”‚  â”œâ”€ ThemeEditor   â”‚      â”‚
â”‚  â”‚  â””â”€ Menus      â”‚    â”‚  â””â”€ Popouts    â”‚    â”‚  â””â”€ LayoutManager â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                     â”‚                        â”‚                 â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                 â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   GUI Components    â”‚    â”‚   Business Logic     â”‚
         â”‚   (src/)            â”‚    â”‚   (data/)            â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ â€¢ chart/            â”‚    â”‚ â€¢ chart/             â”‚
         â”‚   - heatmap.rs      â”‚â—„â”€â”€â”€â”¤   - heatmap.rs       â”‚
         â”‚   - kline.rs        â”‚    â”‚   - kline.rs         â”‚
         â”‚   - comparison.rs   â”‚    â”‚   - comparison.rs    â”‚
         â”‚                     â”‚    â”‚                      â”‚
         â”‚ â€¢ screen/           â”‚    â”‚ â€¢ aggr/              â”‚
         â”‚   - dashboard/      â”‚    â”‚   - time.rs          â”‚
         â”‚   - pane.rs         â”‚    â”‚   - ticks.rs         â”‚
         â”‚                     â”‚    â”‚                      â”‚
         â”‚ â€¢ widget/           â”‚    â”‚ â€¢ config/            â”‚
         â”‚   - toast.rs        â”‚    â”‚   - state.rs         â”‚
         â”‚   - multi_split.rs  â”‚    â”‚   - theme.rs         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Data Sources (exchange/)      â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ â€¢ adapter/                      â”‚
                    â”‚   - binance.rs    ğŸŸ¢ Binance    â”‚
                    â”‚   - bybit.rs      ğŸ”µ Bybit      â”‚
                    â”‚   - hyperliquid.rs ğŸŸ£ Hyperliq  â”‚
                    â”‚   - okex.rs       ğŸŸ¡ OKX        â”‚
                    â”‚                                 â”‚
                    â”‚ â€¢ connect.rs   (WebSocket)      â”‚
                    â”‚ â€¢ fetcher.rs   (REST API)       â”‚
                    â”‚ â€¢ depth.rs     (Orderbook)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ å›¾è¡¨ç³»ç»Ÿè¯¦ç»†ç»“æ„

```
å›¾è¡¨æŠ½è±¡å±‚ (trait Chart)
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼              â–¼              â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Heatmap â”‚   â”‚  Kline  â”‚   â”‚Comparisonâ”‚   â”‚  æ‰©å±•... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚
     â”‚              â”‚              â”‚
     â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ViewState (ç»Ÿä¸€çŠ¶æ€ç®¡ç†)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ translation: Vector    // å¹³ç§»                    â”‚
â”‚ â€¢ scaling: f32           // ç¼©æ”¾                    â”‚
â”‚ â€¢ cell_width/height      // å•å…ƒæ ¼å°ºå¯¸              â”‚
â”‚ â€¢ basis: Basis           // åæ ‡åŸºå‡†(æ—¶é—´/Tick)     â”‚
â”‚ â€¢ bounds: Rectangle      // å¯è§åŒºåŸŸ                â”‚
â”‚ â€¢ cache: Caches          // æ¸²æŸ“ç¼“å­˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Interaction (äº¤äº’æ¨¡å¼)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ None          - æ— äº¤äº’                            â”‚
â”‚ â€¢ Panning       - æ‹–æ‹½å¹³ç§»                          â”‚
â”‚ â€¢ Zoomin        - ç¼©æ”¾                              â”‚
â”‚ â€¢ Ruler         - æµ‹é‡å·¥å…·                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å›¾è¡¨æ¸²æŸ“æµç¨‹

```
ç”¨æˆ·æ“ä½œ (é¼ æ ‡/é”®ç›˜)
    â”‚
    â–¼
canvas::Program::update()
    â”‚
    â”œâ”€â†’ canvas_interaction()   // å¤„ç†äº¤äº’
    â”‚       â”‚
    â”‚       â”œâ”€â†’ é¼ æ ‡æ»šè½® â†’ Message::Scaled
    â”‚       â”œâ”€â†’ æ‹–æ‹½     â†’ Message::Translated
    â”‚       â””â”€â†’ Shift    â†’ Message::Ruler
    â”‚
    â–¼
Chart::update(&Message)
    â”‚
    â”œâ”€â†’ æ›´æ–° ViewState
    â”‚   â”œâ”€ translation
    â”‚   â”œâ”€ scaling
    â”‚   â””â”€ cell_width/height
    â”‚
    â””â”€â†’ invalidate_all() / invalidate_crosshair()
            â”‚
            â””â”€â†’ cache.clear()
                    â”‚
                    â–¼
           canvas::Program::draw()
                    â”‚
                    â”œâ”€â†’ main cache     (ä¸»å†…å®¹)
                    â”œâ”€â†’ x_labels cache (Xè½´)
                    â”œâ”€â†’ y_labels cache (Yè½´)
                    â””â”€â†’ crosshair cache(åå­—çº¿)
                            â”‚
                            â–¼
                    è¿”å› Vec<Geometry>
                            â”‚
                            â–¼
                        GPUæ¸²æŸ“
```

---

## ğŸ“¡ æ•°æ®æµå‘è¯¦è§£

### 1. WebSocket å®æ—¶æ•°æ®æµ

```
äº¤æ˜“æ‰€ WebSocket
    â”‚
    â”‚ (JSONæ¶ˆæ¯)
    â–¼
adapter::parse_message()
    â”‚
    â”œâ”€â†’ Trade  
    â”œâ”€â†’ Depth  
    â””â”€â†’ Kline  
        â”‚
        â–¼
Event::DepthReceived(stream, depth, trades)
        â”‚
        â–¼
Flowsurface::update()
        â”‚
        â–¼
Dashboard::update_depth_and_trades()
        â”‚
        â”œâ”€â†’ TimeAggregator::add_trade()    (æ—¶é—´èšåˆ)
        â”‚   â””â”€â†’ BTreeMap<u64, DataPoint>
        â”‚
        â”œâ”€â†’ TickAggregator::add_trade()    (Tickèšåˆ)
        â”‚   â””â”€â†’ BTreeMap<u64, DataPoint>
        â”‚
        â””â”€â†’ Chart::invalidate()            (è§¦å‘é‡ç»˜)
```

### 2. REST API å†å²æ•°æ®æµ (ä»…Binance)

```
ç”¨æˆ·æ»šåŠ¨å›¾è¡¨ â†’ è§¦å‘å†å²æ•°æ®è¯·æ±‚
        â”‚
        â–¼
RequestHandler::add_request(FetchRange)
        â”‚
        â–¼
fetcher::fetch_historical_trades()
        â”‚
        â”œâ”€â†’ binance.vision (æ‰¹é‡ä¸‹è½½)
        â”‚   â””â”€â†’ ZIPæ–‡ä»¶ â†’ è§£å‹ â†’ è§£æCSV
        â”‚
        â””â”€â†’ REST API (å®æ—¶è¡¥å……)
            â””â”€â†’ /fapi/v1/aggTrades
                    â”‚
                    â–¼
        FetchedData(Vec<Trade>)
                    â”‚
                    â–¼
Dashboard::distribute_fetched_data()
                    â”‚
                    â–¼
        æ’å…¥åˆ°å¯¹åº”çš„ Aggregator
                    â”‚
                    â–¼
                Charté‡ç»˜
```

---

## ğŸ—‚ï¸ æ–‡ä»¶èŒè´£çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | GUIå±‚ (src/) | æ•°æ®å±‚ (data/) | äº¤æ˜“æ‰€å±‚ (exchange/) |
|---------|-------------|---------------|-------------------|
| **å›¾è¡¨æ¸²æŸ“** | `chart/*.rs` (Canvasç»˜åˆ¶) | `chart/*.rs` (æ•°æ®ç»“æ„) | - |
| **æ•°æ®èšåˆ** | - | `aggr/{time,ticks}.rs` | - |
| **WebSocket** | - | - | `connect.rs` + `adapter/*.rs` |
| **å†å²æ•°æ®** | - | - | `fetcher.rs` |
| **é…ç½®ç®¡ç†** | `layout.rs` (åŠ è½½) | `config/state.rs` (å®šä¹‰) | - |
| **ä¸»é¢˜æ ·å¼** | `style.rs` (åº”ç”¨) | `config/theme.rs` (å®šä¹‰) | - |
| **çª—æ ¼å¸ƒå±€** | `screen/dashboard/pane.rs` | `layout/pane.rs` | - |
| **äº¤æ˜“å¯¹ä¿¡æ¯** | `screen/dashboard/tickers_table.rs` | - | `lib.rs` (Ticker) |
| **éŸ³é¢‘æ’­æ”¾** | `audio.rs` (æ’­æ”¾) | `audio.rs` (é…ç½®) | - |
| **é€šçŸ¥æç¤º** | `widget/toast.rs` | - | - |

---

## ğŸ”„ çŠ¶æ€ç®¡ç†æµç¨‹

### Elm æ¶æ„æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Flowsurface                        â”‚
â”‚                   (å…¨å±€çŠ¶æ€å®¹å™¨)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  struct Flowsurface {                                     â”‚
â”‚      main_window: Window,                                 â”‚
â”‚      sidebar: Sidebar,                                    â”‚
â”‚      layout_manager: LayoutManager,                       â”‚
â”‚      theme_editor: ThemeEditor,                           â”‚
â”‚      audio_stream: AudioStream,                           â”‚
â”‚      // ...                                               â”‚
â”‚  }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                      â–²
              â”‚ (Message)            â”‚ (Task)
              â–¼                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Flowsurface::update()                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  match message {                                         â”‚
â”‚      Message::Sidebar(msg) => sidebar.update(msg),       â”‚
â”‚      Message::Dashboard(msg) => dashboard.update(msg),   â”‚
â”‚      Message::MarketWsEvent(event) => { /* ... */ },     â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Flowsurface::view()                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Element::new(                                           â”‚
â”‚      sidebar.view().map(Message::Sidebar),               â”‚
â”‚      dashboard.view().map(Message::Dashboard),           â”‚
â”‚  )                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        æ¸²æŸ“åˆ°å±å¹•
```

### çŠ¶æ€æŒä¹…åŒ–

```
åº”ç”¨å¯åŠ¨
    â”‚
    â–¼
layout::load_saved_state()
    â”‚
    â”œâ”€â†’ è¯»å– saved-state.json
    â”‚   â””â”€â†’ data::State
    â”‚       â”œâ”€ layouts: Vec<Layout>
    â”‚       â”œâ”€ theme: Theme
    â”‚       â”œâ”€ timezone: UserTimezone
    â”‚       â””â”€ ...
    â”‚
    â””â”€â†’ ååºåˆ—åŒ–
            â”‚
            â–¼
    åˆå§‹åŒ– Flowsurface

åº”ç”¨é€€å‡º
    â”‚
    â–¼
save_state_to_disk()
    â”‚
    â”œâ”€â†’ æ”¶é›†æ‰€æœ‰çª—å£çŠ¶æ€
    â”œâ”€â†’ åºåˆ—åŒ– data::State
    â””â”€â†’ å†™å…¥ saved-state.json
```

---

## ğŸ¯ å…³é”®ç»„ä»¶äº¤äº’å›¾

### çª—æ ¼ç³»ç»Ÿ

```
Dashboard
    â”‚
    â”œâ”€â†’ panes: PaneGrid<State>  (ä¸»çª—å£çª—æ ¼ç½‘æ ¼)
    â”‚       â”‚
    â”‚       â”œâ”€ Pane 1: Heatmap
    â”‚       â”œâ”€ Pane 2: Kline
    â”‚       â””â”€ Pane 3: Ladder
    â”‚
    â”œâ”€â†’ popout: HashMap<WindowId, (PaneGrid, WindowSpec)>  (å¼¹å‡ºçª—å£)
    â”‚       â”‚
    â”‚       â””â”€ Window A: Pane 4: TimeAndSales
    â”‚
    â””â”€â†’ streams: UniqueStreams  (æ•°æ®æµç®¡ç†)
            â”‚
            â”œâ”€ depth_streams: Vec<StreamConfig>
            â””â”€ kline_streams: Vec<StreamConfig>

æ¯ä¸ª Pane åŒ…å«:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   struct State {           â”‚
â”‚       id: uuid::Uuid,      â”‚
â”‚       content: Content,    â”‚  â† å›¾è¡¨æˆ–é¢æ¿
â”‚       status: Status,      â”‚  â† Ready/Loading/Error
â”‚       link_group: Option,  â”‚  â† è”åŠ¨ç»„
â”‚       notifications: Vec,  â”‚  â† é€šçŸ¥é˜Ÿåˆ—
â”‚   }                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
enum Content {
    Heatmap { chart, interaction },
    Kline { chart, interaction },
    Comparison { chart, interaction },
    Ladder { panel },
    TimeAndSales { panel },
    Empty,
}
```

### æ•°æ®æµè®¢é˜…æœºåˆ¶

```
UniqueStreams (ç¡®ä¿ä¸é‡å¤è®¢é˜…)
    â”‚
    â”œâ”€â†’ depth_map: HashMap<StreamKey, Subscription>
    â”‚   â””â”€ StreamKey = (Exchange, Ticker, StreamKind)
    â”‚
    â””â”€â†’ kline_map: HashMap<(Exchange, Ticker, Timeframe), Subscription>

è®¢é˜…æµç¨‹:
1. Pane::update() 
     â†’ è¯·æ±‚è®¢é˜… BTCUSDT Heatmap
     
2. Dashboard::update()
     â†’ streams.subscribe(StreamConfig)
     
3. UniqueStreams::subscribe()
     â†’ æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
     â”œâ”€ å­˜åœ¨ â†’ è¿”å›ç°æœ‰ Subscription
     â””â”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–° WebSocket è¿æ¥
     
4. Subscription::run()
     â†’ æŒç»­æ¥æ”¶æ•°æ®
     â†’ å‘é€ Message::MarketWsEvent
     
5. Dashboard::update_depth_and_trades()
     â†’ åˆ†å‘åˆ°æ‰€æœ‰è®¢é˜…è¯¥æµçš„ Pane
```

---

## ğŸ§© æ¨¡å—ä¾èµ–å…³ç³»

```
ä¸»åº”ç”¨ (flowsurface)
    â”œâ”€ ä¾èµ–: data, exchange
    â””â”€ è´Ÿè´£: GUIã€çª—å£ã€äº¤äº’

æ•°æ®å±‚ (data)
    â”œâ”€ ä¾èµ–: exchange (ä»…ç±»å‹)
    â”œâ”€ è´Ÿè´£: æ•°æ®ç»“æ„ã€èšåˆã€é…ç½®
    â””â”€ å¯ç‹¬ç«‹: âœ… (å¯ä½œä¸ºåº“ä½¿ç”¨)

äº¤æ˜“æ‰€å±‚ (exchange)
    â”œâ”€ ä¾èµ–: æ—  (ä»…æ ‡å‡†åº“)
    â”œâ”€ è´Ÿè´£: WebSocketã€REST APIã€é€‚é…å™¨
    â””â”€ å¯ç‹¬ç«‹: âœ… (å¯ä½œä¸ºåº“ä½¿ç”¨)
```

### Cargo ä¾èµ–æ ‘ (ç®€åŒ–ç‰ˆ)

```
flowsurface
â”œâ”€â”€ iced (GUIæ¡†æ¶)
â”‚   â”œâ”€â”€ wgpu (GPUæ¸²æŸ“)
â”‚   â””â”€â”€ tokio (å¼‚æ­¥è¿è¡Œæ—¶)
â”œâ”€â”€ data (å·¥ä½œç©ºé—´æˆå‘˜)
â”‚   â”œâ”€â”€ serde (åºåˆ—åŒ–)
â”‚   â”œâ”€â”€ chrono (æ—¶é—´)
â”‚   â””â”€â”€ exchange (å·¥ä½œç©ºé—´æˆå‘˜)
â””â”€â”€ exchange (å·¥ä½œç©ºé—´æˆå‘˜)
    â”œâ”€â”€ tungstenite (WebSocket)
    â”œâ”€â”€ reqwest (HTTP)
    â””â”€â”€ serde_json (JSONè§£æ)
```

---

## ğŸ“‹ å¿«é€ŸæŸ¥æ‰¾è¡¨

### æ·»åŠ åŠŸèƒ½æ—¶éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

#### 1. æ·»åŠ æ–°å›¾è¡¨ç±»å‹

| æ­¥éª¤ | æ–‡ä»¶ | è¯´æ˜ |
|-----|------|------|
| 1ï¸âƒ£ | `data/src/chart/your_chart.rs` | æ•°æ®æ¨¡å‹ |
| 2ï¸âƒ£ | `data/src/layout/pane.rs` | æ·»åŠ åˆ° `ContentKind` |
| 3ï¸âƒ£ | `src/chart/your_chart.rs` | å®ç° `Chart` trait |
| 4ï¸âƒ£ | `src/screen/dashboard/pane.rs` | æ·»åŠ åˆ° `Content` enum |
| 5ï¸âƒ£ | `src/modal/pane/settings.rs` | æ·»åŠ åˆ°å›¾è¡¨é€‰æ‹©å™¨ |

#### 2. æ·»åŠ æ–°äº¤æ˜“æ‰€

| æ­¥éª¤ | æ–‡ä»¶ | è¯´æ˜ |
|-----|------|------|
| 1ï¸âƒ£ | `exchange/src/adapter/your_exchange.rs` | å®ç°é€‚é…å™¨ |
| 2ï¸âƒ£ | `exchange/src/adapter/adapter.rs` | æ·»åŠ åˆ° `Exchange` enum |
| 3ï¸âƒ£ | `exchange/src/connect.rs` | æ³¨å†Œè¿æ¥é€»è¾‘ |
| 4ï¸âƒ£ | `src/style.rs` | æ·»åŠ  Logo å›¾æ ‡ |

#### 3. æ·»åŠ æ–°é…ç½®é¡¹

| æ­¥éª¤ | æ–‡ä»¶ | è¯´æ˜ |
|-----|------|------|
| 1ï¸âƒ£ | `data/src/config/state.rs` | æ·»åŠ å­—æ®µåˆ° `State` |
| 2ï¸âƒ£ | `src/main.rs` | æ·»åŠ åˆ° `Flowsurface` struct |
| 3ï¸âƒ£ | `src/main.rs` (view) | æ·»åŠ  UI æ§ä»¶ |
| 4ï¸âƒ£ | `src/main.rs` (update) | å¤„ç†å˜æ›´æ¶ˆæ¯ |

#### 4. æ·»åŠ å›½é™…åŒ–

| æ­¥éª¤ | æ–‡ä»¶ | è¯´æ˜ |
|-----|------|------|
| 1ï¸âƒ£ | `Cargo.toml` | æ·»åŠ  `rust-i18n` ä¾èµ– |
| 2ï¸âƒ£ | `locales/en-US.yml` | è‹±æ–‡ç¿»è¯‘ |
| 3ï¸âƒ£ | `locales/zh-CN.yml` | ä¸­æ–‡ç¿»è¯‘ |
| 4ï¸âƒ£ | `src/i18n.rs` (æ–°å»º) | i18n åˆå§‹åŒ– |
| 5ï¸âƒ£ | æ‰€æœ‰ UI æ–‡ä»¶ | æ›¿æ¢ç¡¬ç¼–ç æ–‡æœ¬ |

---

## ğŸ¨ UI ç»„ä»¶å±‚æ¬¡ç»“æ„

```
Window (iced::Window)
    â”‚
    â”œâ”€ macOS: Title Bar (20px padding)
    â”‚
    â””â”€ Container
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â”‚                 â”‚
        â–¼                 â–¼
    Sidebar          Dashboard
    â”‚                    â”‚
    â”œâ”€ Logo             â”œâ”€ PaneGrid
    â”œâ”€ Search           â”‚   â”‚
    â”œâ”€ Tickers List     â”‚   â”œâ”€ Pane (Heatmap)
    â”‚  â””â”€ Scrollable    â”‚   â”‚   â”œâ”€ Title Bar
    â”‚                   â”‚   â”‚   â”œâ”€ Chart Canvas
    â”œâ”€ Menu Buttons     â”‚   â”‚   â””â”€ Controls
    â”‚  â”œâ”€ Layout        â”‚   â”‚
    â”‚  â”œâ”€ Audio         â”‚   â”œâ”€ Pane (Kline)
    â”‚  â””â”€ Settings      â”‚   â””â”€ ...
    â”‚                   â”‚
    â””â”€ Footer           â””â”€ Focus Indicator
            â”‚                       â”‚
            â–¼                       â–¼
        Modal Overlay        Selected Pane Highlight
            â”‚
            â”œâ”€ Settings Modal
            â”œâ”€ Layout Manager
            â”œâ”€ Theme Editor
            â””â”€ Confirm Dialog
```

---

## ğŸ” å¸¸è§é—®é¢˜å¿«é€Ÿç´¢å¼•

| é—®é¢˜ | æ¶‰åŠæ–‡ä»¶ | å…³é”®å­— |
|-----|---------|-------|
| å›¾è¡¨ä¸æ›´æ–° | `src/chart/*.rs` | `invalidate_all()` |
| WebSocket æ–­çº¿ | `exchange/src/connect.rs` | `reconnect_delay` |
| æ•°æ®ç¼ºå¤± | `data/src/aggr/*.rs` | `add_trade()` |
| å¸ƒå±€ä¸ä¿å­˜ | `src/layout.rs` | `save_state_to_disk()` |
| ä¸»é¢˜ä¸ç”Ÿæ•ˆ | `src/style.rs` | `theme()` |
| æ€§èƒ½å¡é¡¿ | `src/chart/*.rs` | `cache.draw()` |
| äº¤æ˜“å¯¹æœç´¢æ…¢ | `src/screen/dashboard/tickers_table.rs` | ç´¢å¼•ä¼˜åŒ– |

---

## ğŸ“Š æ€§èƒ½å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›¸å…³ä»£ç  |
|-----|-------|---------|
| å¸§ç‡ | > 60 FPS | `canvas::draw()` è€—æ—¶ < 16ms |
| WebSocketå»¶è¿Ÿ | < 100ms | `adapter::parse_message()` |
| æ•°æ®èšåˆ | < 5ms | `TimeAggregator::add_trade()` |
| å¸ƒå±€åŠ è½½ | < 500ms | `layout::load_saved_state()` |
| å†…å­˜å ç”¨ | < 500MB | å®šæœŸæ¸…ç†æ—§æ•°æ® |

---

## ğŸ› ï¸ å¼€å‘å·¥ä½œæµ

```
1. éœ€æ±‚åˆ†æ
    â”œâ”€ ç¡®å®šåŠŸèƒ½ç±»å‹ (å›¾è¡¨/äº¤æ˜“æ‰€/é…ç½®)
    â””â”€ æŸ¥çœ‹æœ¬æ–‡æ¡£å®šä½ç›¸å…³æ–‡ä»¶
        â”‚
        â–¼
2. åˆ›å»ºåˆ†æ”¯
    â””â”€ git checkout -b feature/your-feature
        â”‚
        â–¼
3. å®ç°åŠŸèƒ½
    â”œâ”€ æ•°æ®å±‚ (data/)
    â”œâ”€ ä¸šåŠ¡é€»è¾‘ (src/screen/)
    â””â”€ UIå±‚ (src/chart/, src/widget/)
        â”‚
        â–¼
4. æµ‹è¯•
    â”œâ”€ cargo test
    â”œâ”€ cargo run (æ‰‹åŠ¨æµ‹è¯•)
    â””â”€ cargo clippy (é™æ€æ£€æŸ¥)
        â”‚
        â–¼
5. æäº¤
    â”œâ”€ git add .
    â”œâ”€ git commit -m "feat: ..."
    â””â”€ git push
```

---

**å›¾ä¾‹è¯´æ˜**:
- `â”Œâ”€â”` å®¹å™¨/æ¨¡å—è¾¹ç•Œ
- `â”‚` æ•°æ®æµ/ä¾èµ–å…³ç³»
- `â–¼` å‘ä¸‹æµåŠ¨
- `â—„â”€` åŒå‘é€šä¿¡
- `â”œâ”€` åˆ†æ”¯/é€‰é¡¹

**ç‰ˆæœ¬**: åŸºäº Flowsurface v0.8.6  
**æ›´æ–°**: 2025-12-25

